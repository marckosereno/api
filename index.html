<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso Tour Guide</title>
<link href="https://fonts.cdnfonts.com/css/avenir" rel="stylesheet">
                
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Estilos base: Asegurar Full Height y Full Width */
        html, body { font-family:Avenir; height: 100%; margin: 0; padding: 0; }
        .chat-window { height: 100%; width: 100vw; display: flex; flex-direction: column; background-color: #f7f7f7; overflow: hidden }
        .user-bubble { border-radius: 18px 18px 0 18px; max-width: 80% }
        .model-bubble { border-radius: 18px 18px 18px 0; max-width: 80%;padding-left:8px; }
        .action-bar-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-top: 10px; padding-bottom: 5px }
        .action-btn { white-space: nowrap }
        
        /* Ajuste de Chips: Asegura el scroll horizontal */
        .chip-group-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
        
        /* Indicador de Carga */
        .dot-flashing { position: relative; width: 10px; height: 10px; border-radius: 5px; background-color: #909090; animation: dotFlashing 1s infinite alternate; animation-delay: 0s }
        .dot-flashing::before, .dot-flashing::after { content: ''; position: absolute; top: 0; width: 10px; height: 10px; border-radius: 5px; background-color: #909090; animation: dotFlashing 1s infinite alternate }
        .dot-flashing::before { left: -15px; animation-delay: .5s }
        .dot-flashing::after { left: 15px; animation-delay: 1s }
        @keyframes dotFlashing { 0% { background-color: #909090 } 50%, 100% { background-color: #cacaca } }
    </style>
</head>
<body>
    <div id="chat-window" class="chat-window h-screen w-full"> 
        <div class="flex items-center justify-between p-4 bg-white text-gray-800 font-bold border-b border-gray-200 flex-shrink-0 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            <span class="text-lg">PROGRESO TOUR GUIDE</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </div>

        <div id="message-container" class="flex-grow overflow-y-auto p-4 flex flex-col"></div>

        <div id="loading-indicator" class="flex justify-start hidden p-4 flex-shrink-0">
            <div class="dot-flashing"></div>
        </div>
        
        <div id="app-alert-container" class="fixed top-2 w-full flex justify-center z-50"></div>

        <div id="quick-replies-container" class="quick-replies-container p-3 border-t border-gray-100 bg-white flex-shrink-0 flex flex-col space-y-2">
            
            <div class="chip-group-scroll">
                <div class="inline-flex space-x-3 pb-3 border-b border-gray-200"> <div class="quick-reply-chip category-chip flex items-center p-2 rounded-xl text-sm border border-green-500 bg-green-50 text-green-700 cursor-pointer transition hover:bg-green-100" data-query="Categor√≠a Salud y Est√©tica en Progreso">üè• Salud & Est√©tica</div>
                    <div class="quick-reply-chip category-chip flex items-center p-2 rounded-xl text-sm border border-blue-500 bg-blue-50 text-blue-700 cursor-pointer transition hover:bg-blue-100" data-query="Categor√≠a Compras y Tiendas en Progreso">üõçÔ∏è Compras</div>
                    <div class="quick-reply-chip category-chip flex items-center p-2 rounded-xl text-sm border border-purple-500 bg-purple-50 text-purple-700 cursor-pointer transition hover:bg-purple-100" data-query="Categor√≠a Entretenimiento y Atracciones en Progreso">üé∫ Entretenimiento</div>
                </div>
            </div>
            
            <div class="chip-group-scroll">
                <div class="inline-flex space-x-3 pt-2">
                    <div class="quick-reply-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-query="Dime c√≥mo llegar a Progreso">üìç C√≥mo Llegar</div>
                    <div class="quick-reply-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-query="Recomi√©ndame d√≥nde comer y beber en Progreso">üåÆ Comer & Beber</div>
                </div>
            </div>
        </div>

        <div class="flex items-center p-4 border-t border-gray-100 bg-white shadow-lg flex-shrink-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-2 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.414a2 2 0 00-2.828-2.828l-6.414 6.414a1 1 0 00.707 1.707H17" /></svg>
            
            <input type="text" id="user-input" class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="Pregunta lo que sea...">
            
            <div class="flex items-center ml-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-3 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 4a3 3 0 00-3 3v4a3 3 0 006 0V7a3 3 0 00-3-3v0zM4 11H3a9 9 0 0018 0h-1" /></svg>
                
                <button id="send-button" class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-md transition hover:bg-blue-600 disabled:bg-gray-400 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.286L12 21l-2.286-6.857L3 12l5.714-2.286L12 3z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

<script>
    // --- BLOQUE JAVASCRIPT: SETUP Y UTILIDADES ---
    
    // ‚úÖ RUTA RELATIVA: Usamos /api. Como el frontend y el backend est√°n en el mismo dominio (Vercel), el CORS se elimina.
    const BACKEND_URL = "/api"; 
    
    let chatHistory = [];
    
    // Referencias a Elementos del DOM
    const inputElement = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const messageContainer = document.getElementById('message-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const appAlertContainer = document.getElementById('app-alert-container');
    const quickRepliesContainer = document.getElementById('quick-replies-container');

    // Inicializaci√≥n del estado
    if (inputElement) inputElement.disabled = false;
    if (sendButton) sendButton.disabled = false;

    // Funci√≥n para mostrar alertas temporales
    function alertUser(m, t='i') {
        if (appAlertContainer && appAlertContainer.querySelector('.app-alert')) appAlertContainer.querySelector('.app-alert').remove();
        const a = document.createElement('div');
        const bg = (t === 'error') ? 'bg-red-500' : 'bg-blue-500';
        a.className = `app-alert p-3 rounded-lg text-white font-semibold shadow-lg transition-opacity duration-300 z-50 ${bg} mb-2`;
        a.textContent = m;
        if (appAlertContainer) appAlertContainer.appendChild(a);
        setTimeout(() => { a.style.opacity = '0'; setTimeout(() => a.remove(), 300); }, 4000);
    }
    
    // Funci√≥n para hacer scroll
    function scrollToBottom() { 
        if (messageContainer) messageContainer.scrollTop = messageContainer.scrollHeight; 
    }
    
    // Funci√≥n para gestionar el estado de entrada
    function toggleInput(d) {
        if (inputElement) inputElement.disabled = d;
        if (sendButton) sendButton.disabled = d;
        if (loadingIndicator) loadingIndicator.classList.toggle('hidden', !d);
        if (inputElement) inputElement.placeholder = d ? "Esperando respuesta de IA..." : "Pregunta lo que sea...";
    }
    
    // Funci√≥n para crear las burbujas de mensaje (User/Model)
    function createMessageBubble(m) {
        const w = document.createElement('div');
        
        if (m.role === 'user') { 
            w.className = 'flex justify-end mb-2'; 
            w.innerHTML = `<div class="user-bubble bg-blue-500 text-white p-3 shadow-md">${m.text}</div>`; 
        } 
        else if (m.role === 'model') {
            w.className = 'flex flex-col justify-start w-full mb-2';
            let content = '';

            if (m.isStructured) {
                // L√≥gica para mensajes estructurados con botones de acci√≥n
                const nameAndCity = encodeURIComponent(m.placeName + " Nuevo Progreso Tamps");
                // Nota: Usamos una URL gen√©rica para Google Maps ya que la Places API no est√° activa
                const directionsUrl = `https://www.google.com/maps/search/?api=1&query=${nameAndCity}`; 
                const searchUrl = `https://www.google.com/search?q=${nameAndCity}`;
                const phoneUrl = m.placePhone ? `tel:${m.placePhone}` : `javascript:alert('N√∫mero de tel√©fono gen√©rico. No se puede llamar.')`;
                
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">¬°Claro! Aqu√≠ est√° la informaci√≥n sobre **${m.placeName}** que tengo como tu gu√≠a local:<br><br>${m.text}</div>`;
                
                const isGenericPhone = m.placePhone === '+52 899 900 0000';
                
                const actionsBar = `
                    <div class="action-bar-container">
                        <div class="inline-flex space-x-3 p-1">
                            <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition flex-shrink-0 text-sm">Ver en Mapa üó∫Ô∏è</a>
                            <a href="${phoneUrl}" class="action-btn ${isGenericPhone ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600' } text-white font-semibold py-2 px-4 rounded-lg transition flex-shrink-0 text-sm">Llamar üìû</a>
                            <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-yellow-500 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition flex-shrink-0 text-sm">Buscar en Google üîç</a>
                        </div>
                    </div>
                `;
                
                w.innerHTML = content + actionsBar;

            } else {
                // L√≥gica para mensajes de texto simple
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">${m.text || ''}</div>`;
                w.innerHTML = content;
            }
        }
        return w;
    }

    // Funci√≥n para renderizar el historial de chat
    function renderChat() {
        if (messageContainer) {
            messageContainer.innerHTML = '';
            chatHistory.forEach((m) => { messageContainer.appendChild(createMessageBubble(m)); });
            scrollToBottom();
        }
    }

    // --- BLOQUE JAVASCRIPT: L√ìGICA CENTRAL Y EVENTOS ---

    // Funci√≥n que llama al proxy de Vercel (donde reside la clave)
    async function getGeminiResponse(userPrompt, chatHistoryForAPI) {
        
        const LATITUDE = 26.064;
        const LONGITUDE = -98.005;

        // Se mantiene el System Prompt para la IA
        const systemPrompt = `Eres PROGRESO TOUR GUIDE, un gu√≠a experto en Nuevo Progreso, Tamaulipas, M√©xico (${LATITUDE}, ${LONGITUDE}). Tu objetivo es detectar si el usuario pregunta por un lugar espec√≠fico. TODOS los lugares DEBEN estar en esta ciudad. Usa el contexto conversacional.
        
        **INSTRUCCIONES:** 1. Si detectas un lugar espec√≠fico: **SOLO UN OBJETO JSON**. 2. Pregunta o categor√≠a general: **SOLO TEXTO PLANO**.
        
        **FORMATO JSON REQUERIDO:**
        \`\`\`json
        {
          "placeName": "Nombre del Lugar Exacto",
          "description": "Saludo y descripci√≥n atractiva, enfocada en compras, salud o diversi√≥n. Termina invitando al usuario a usar los botones para mapa o contacto.",
          "placePhone": "+52 899 900 0000",
          "isStructured": true
        }
        \`\`\`
        `;
        
        let contents = [];
        chatHistoryForAPI.forEach(m => {
            let textToSend = m.isStructured ? `[PROGRESO TOUR GUIDE ENVI√ì FICHA sobre ${m.placeName}]` : m.text;
            if (m.role && textToSend && textToSend.length > 5) { contents.push({ role: m.role, parts: [{ text: textToSend }] }); }
        });

        contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\nSolicitud del usuario: " + userPrompt }] });

        try {
            // LLamada al proxy de Vercel con URL RELATIVA
            const response = await fetch(BACKEND_URL, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: contents }) 
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error HTTP: ${response.status}. Mensaje: ${errorData.error.message || 'El proxy de Vercel fall√≥.'}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();

        } catch (error) {
            console.error("Fallo del Proxy o API de Gemini:", error);
            if (typeof alertUser === 'function') {
                alertUser(`Error de conexi√≥n con el servidor (Proxy Vercel): ${error.message}.`, 'error');
            }
            return null;
        }
    }

    // --- L√≥gica Principal del Chatbot (handleSend) ---
    async function handleSend(userPromptInput = null) {
        const userPrompt = userPromptInput || inputElement.value.trim();
        if (!userPrompt) return;
        
        if (typeof toggleInput === 'function') toggleInput(true);
        chatHistory.push({ role: 'user', text: userPrompt });
        if (typeof renderChat === 'function') renderChat();
        inputElement.value = '';

        const historyForGemini = [...chatHistory];
        historyForGemini.pop(); 
        
        const MAX_MESSAGES = 6;
        let limitedHistory = historyForGemini.length > MAX_MESSAGES ? historyForGemini.slice(historyForGemini.length - MAX_MESSAGES) : historyForGemini;
        
        let modelResponseText = await getGeminiResponse(userPrompt, limitedHistory);
        let finalMessage = { role: 'model', text: modelResponseText };

        // Intenta parsear la respuesta como JSON estructurado
        try {
            const jsonStart = modelResponseText.indexOf('{');
            const jsonEnd = modelResponseText.lastIndexOf('}');
            
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonString = modelResponseText.substring(jsonStart, jsonEnd + 1);
                const parsedJson = JSON.parse(jsonString);

                if (parsedJson.isStructured === true) {
                    finalMessage = {
                        role: 'model',
                        isStructured: true,
                        text: parsedJson.description || modelResponseText,
                        placeName: parsedJson.placeName,
                        placePhone: parsedJson.placePhone,
                        placeId: true 
                    };
                    if (typeof alertUser === 'function') alertUser(`¬°Ficha generada por IA para ${parsedJson.placeName}!`, "i");
                }
            }
        } catch (e) {
            finalMessage.text = modelResponseText;
        }

        chatHistory.push(finalMessage);
        
        if (typeof renderChat === 'function') renderChat();
        if (typeof toggleInput === 'function') toggleInput(false);
    }
    
    // --- Event Listeners e Inicio ---
    if (sendButton) sendButton.addEventListener('click', () => handleSend());
    if (inputElement) inputElement.addEventListener('keypress', function(e) { if (e.key === 'Enter') { handleSend(); } });
    
    // Event listeners para todos los chips (Categor√≠a y Acci√≥n) usando data-query
    document.querySelectorAll('[data-query]').forEach(chip => {
        chip.addEventListener('click', function() {
            const query = this.getAttribute('data-query');
            handleSend(query); 
        });
    });
</script>
</body>
</html>
