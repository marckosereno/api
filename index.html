<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso Tour Guide</title>
<link href="https://fonts.cdnfonts.com/css/avenir" rel="stylesheet">
                
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Estilos base */
        html, body { font-family:Avenir; height: 100%; margin: 0; padding: 0; }
        .chat-window { height: 100%; width: 100vw; display: flex; flex-direction: column; background-color: #f7f7f7; overflow: hidden }
        .user-bubble { border-radius: 18px 18px 0 18px; max-width: 80% }
        .model-bubble { border-radius: 18px 18px 18px 0; max-width: 80%;padding-left:8px; }
        .action-bar-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-top: 10px; padding-bottom: 5px }
        .action-btn { white-space: nowrap }
        .chip-group-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
        
        /* Estilo de la barra de chat */
        .map-search-bar {
            background-color: white; 
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 4px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .map-input {
            flex-grow: 1;
            padding: 0.75rem 0.75rem; 
            color: #9ca3af;
            font-size: 1.125rem;
            background: transparent;
            border: none;
            min-width: 0; 
            outline: none !important;
            box-shadow: none !important;
        }
        .go-button {
            background-color: black;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 15px;
            padding: 0.5rem 1rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: hover:opacity-90 disabled:opacity-50;
            flex-shrink: 0;
            min-width: 60px;
            height: 44px;
            box-sizing: border-box;
            margin-right: 4px;
            outline: none !important;
        }
        .go-button svg {
            margin-right: 0.25rem;
            width: 1.25rem; 
            height: 1.25rem;
            fill: currentColor;
        }

        /* --- Eliminaci√≥n de Efecto Celeste/Ring/Highlight en TODOS los botones y chips --- */
        
        /* 1. Para navegadores basados en Webkit (Chrome, Safari, Android) */
        * {
            -webkit-tap-highlight-color: transparent !important; /* ‚≠ê SOLUCI√ìN CLAVE para el toque en m√≥vil */
        }
        
        /* 2. Asegura la eliminaci√≥n del outline/ring en estados focus/active */
        .action-chip, .category-chip, .language-chip, .go-button, .map-input {
            outline: none !important;
            box-shadow: none !important;
            --tw-ring-color: transparent !important;
        }
        .action-chip:focus, .action-chip:active, .category-chip:focus, .category-chip:active, .language-chip:focus, .language-chip:active, .go-button:focus, .go-button:active {
            outline: none !important;
            box-shadow: none !important;
            --tw-ring-color: transparent !important;
        }
        .hover\:bg-gray-300:active {
            background-color: #d1d5db; /* mantiene el color del hover al hacer click */
        }
        
        /* --- Efecto Ola y Transici√≥n para los Chips --- */
        .category-chip, .language-chip {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
        }
        .visible-chip {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>
    <div id="chat-window" class="chat-window h-screen w-full"> 
        <div class="flex items-center justify-between p-4 bg-white text-gray-800 font-bold border-b border-gray-200 flex-shrink-0 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            <span id="header-text" class="text-lg">PROGRESO TOUR GUIDE</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </div>

        <div id="message-container" class="flex-grow overflow-y-auto p-4 flex flex-col"></div>

        <div id="loading-indicator" class="flex justify-start hidden p-4 pl-1 flex-shrink-0" style="margin-left:-42px;margin-bottom:-22px;">
            <dotlottie-wc src="https://lottie.host/65b2d1fc-9840-476c-867e-6236ce234b38/SwsGK4ZVOj.lottie" style="width: 150px; height:" autoplay loop></dotlottie-wc>
        </div>
        
        <div id="app-alert-container" class="fixed top-2 w-full flex justify-center z-50"></div>

        <div id="quick-replies-container" class="quick-replies-container p-3 border-t border-gray-100 bg-white flex-shrink-0 flex flex-col space-y-2">
            
            <div id="category-chips-group" class="chip-group-scroll hidden">
                <div id="category-chips-list" class="inline-flex space-x-3 pb-3 border-b border-gray-200"> 
                    <div class="category-chip flex items-center p-2 rounded-xl text-sm border border-green-500 bg-green-50 text-green-700 cursor-pointer transition hover:bg-green-100" data-query-es="Categor√≠a Salud y Est√©tica en Progreso" data-query-en="Health and Beauty Category in Progreso">üè• Salud & Est√©tica</div>
                    <div class="category-chip flex items-center p-2 rounded-xl text-sm border border-blue-500 bg-blue-50 text-blue-700 cursor-pointer transition hover:bg-blue-100" data-query-es="Categor√≠a Compras y Tiendas en Progreso" data-query-en="Shopping and Stores Category in Progreso">üõçÔ∏è Compras</div>
                    <div class="category-chip flex items-center p-2 rounded-xl text-sm border border-purple-500 bg-purple-50 text-purple-700 cursor-pointer transition hover:bg-purple-100" data-query-es="Categor√≠a Entretenimiento y Atracciones en Progreso" data-query-en="Entertainment and Attractions Category in Progreso">üé∫ Entretenimiento</div>
                    <div class="category-chip flex items-center p-2 rounded-xl text-sm border border-yellow-500 bg-yellow-50 text-yellow-700 cursor-pointer transition hover:bg-yellow-100" data-query-es="Top 10 Dentistas en Progreso" data-query-en="Top 10 Dentists in Progreso">ü¶∑ Top 10 Dental</div>
                </div>
            </div>

            <div id="language-chips-group" class="chip-group-scroll hidden">
                <div class="inline-flex space-x-3 pb-3 border-b border-gray-200"> 
                    <div class="language-chip flex items-center p-2 rounded-full text-sm font-semibold border border-gray-400 bg-white text-gray-800 cursor-pointer transition hover:bg-gray-100" data-lang="es">üá™üá∏ Espa√±ol</div>
                    <div class="language-chip flex items-center p-2 rounded-full text-sm font-semibold border border-gray-400 bg-white text-gray-800 cursor-pointer transition hover:bg-gray-100" data-lang="en">üá∫üá∏ English</div>
                </div>
            </div>
            
            <div id="menu-actions" class="chip-group-scroll">
                <div class="inline-flex space-x-3 pt-2">
                    <div id="btn-categorias" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="CATEGORIES">üìÇ Categor√≠as</div>
                    <div id="btn-lenguaje" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="LANGUAGE">üåê Lenguaje</div>
                    <div id="btn-comollegar" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="GET_THERE" data-query-es="Dime c√≥mo llegar a Progreso, Tamaulipas." data-query-en="Tell me how to get to Progreso, Tamaulipas.">üìç C√≥mo Llegar</div>
                    <div id="btn-info" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="INFO" data-query-es="Informaci√≥n general sobre Nuevo Progreso." data-query-en="General information about Nuevo Progreso.">‚ÑπÔ∏è Info</div>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-white shadow-xl flex-shrink-0">
            <div class="map-search-bar w-full">
                <input type="text" id="user-input" class="map-input focus:outline-none focus:ring-0" placeholder="Ask the map">
                
                <button id="go-button" class="go-button transition hover:opacity-90 disabled:opacity-50">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.88" class="h-5 w-5"><g><path class="st0" d="M62.43,122.88h-1.98c0-16.15-6.04-30.27-18.11-42.34C30.27,68.47,16.16,62.43,0,62.43v-1.98 c16.16,0,30.27-6.04,42.34-18.14C54.41,30.21,60.45,16.1,60.45,0h1.98c0,16.15,6.04,30.27,18.11,42.34 c12.07,12.07,26.18,18.11,42.34,18.11v1.98c-16.15,0-30.27,6.04-42.34,18.11C68.47,92.61,62.43,106.72,62.43,122.88L62.43,122.88z"/></g></svg>
                    <span id="go-text">Go</span> 
                </button>
            </div>
        </div>
        </div>

<script>
    // --- BLOQUE JAVASCRIPT: SETUP Y UTILIDADES ---
    
    const BACKEND_URL = "/api"; 
    
    let chatHistory = [];
    let currentLanguage = 'es'; 
    let categoriesVisible = false; 
    let languageMenuVisible = false; 

    // Referencias a Elementos del DOM
    const inputElement = document.getElementById('user-input');
    const sendButton = document.getElementById('go-button'); 
    const messageContainer = document.getElementById('message-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const appAlertContainer = document.getElementById('app-alert-container');
    const categoryChipsGroup = document.getElementById('category-chips-group');
    const languageChipsGroup = document.getElementById('language-chips-group');
    const categoryChips = document.querySelectorAll('#category-chips-group .category-chip');
    const languageChips = document.querySelectorAll('#language-chips-group .language-chip');
    const menuActionChips = document.querySelectorAll('#menu-actions .menu-action-chip');
    
    // Objeto de Traducci√≥n y textos de chips
    const UI_STRINGS = {
        es: {
            header: "PROGRESO TOUR GUIDE",
            placeholder: "Preg√∫ntale al mapa",
            goButton: "Ir",
            categories: "üìÇ Categor√≠as",
            language: "üåê Lenguaje",
            getThere: "üìç C√≥mo Llegar",
            info: "‚ÑπÔ∏è Info",
            alertStructured: (name) => `¬°Ficha generada por IA para ${name}!`,
            chipHealth: "üè• Salud & Est√©tica",
            chipShopping: "üõçÔ∏è Compras",
            chipEntertainment: "üé∫ Entretenimiento",
            chipDental: "ü¶∑ Top 10 Dental",
        },
        en: {
            header: "PROGRESO TOUR GUIDE",
            placeholder: "Ask the map",
            goButton: "Go",
            categories: "üìÇ Categories",
            language: "üåê Language",
            getThere: "üìç How to get there",
            info: "‚ÑπÔ∏è Info",
            alertStructured: (name) => `AI card generated for ${name}!`,
            chipHealth: "üè• Health & Beauty",
            chipShopping: "üõçÔ∏è Shopping",
            chipEntertainment: "üé∫ Entertainment",
            chipDental: "ü¶∑ Top 10 Dental",
        }
    };

    // Inicializaci√≥n del estado
    if (inputElement) inputElement.disabled = false;
    if (sendButton) sendButton.disabled = false;

    function alertUser(m, t='i') {
        if (appAlertContainer && appAlertContainer.querySelector('.app-alert')) appAlertContainer.querySelector('.app-alert').remove();
        const a = document.createElement('div');
        const bg = (t === 'error') ? 'bg-red-500' : 'bg-blue-500';
        a.className = `app-alert p-3 rounded-lg text-white font-semibold shadow-lg transition-opacity duration-300 z-50 ${bg} mb-2`;
        a.textContent = m;
        if (appAlertContainer) appAlertContainer.appendChild(a);
        setTimeout(() => { a.style.opacity = '0'; setTimeout(() => a.remove(), 300); }, 4000);
    }
    
    function scrollToBottom() { 
        if (messageContainer) messageContainer.scrollTop = messageContainer.scrollHeight; 
    }
    
    function toggleInput(d) {
        if (inputElement) inputElement.disabled = d;
        if (sendButton) sendButton.disabled = d;
        if (loadingIndicator) loadingIndicator.classList.toggle('hidden', !d);
        if (inputElement) inputElement.placeholder = d ? "" : UI_STRINGS[currentLanguage].placeholder;
    }

    // --- FUNCIONES DE INTERACCI√ìN ---

    function vibrateDevice() {
        if ("vibrate" in navigator) {
            navigator.vibrate(100); 
        }
    }
    
    function hideChipGroup(groupElement, chipElements) {
        groupElement.classList.add('hidden');
        chipElements.forEach(chip => {
            chip.classList.remove('visible-chip');
        });
    }

    function showChipGroupWithWave(groupElement, chipElements) {
        groupElement.classList.remove('hidden');
        chipElements.forEach((chip, index) => {
            chip.style.transition = 'none';
            chip.classList.remove('visible-chip');

            void chip.offsetWidth; 

            setTimeout(() => {
                chip.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                chip.classList.add('visible-chip');
            }, index * 100); 
        });
    }

    function setInterfaceLanguage(lang) {
        currentLanguage = lang;
        const strings = UI_STRINGS[lang];
        
        // Ocultar men√∫ de lenguaje
        hideChipGroup(languageChipsGroup, languageChips);
        languageMenuVisible = false;

        // Actualizar textos de la interfaz
        document.getElementById('header-text').textContent = strings.header;
        inputElement.placeholder = strings.placeholder;
        document.getElementById('go-text').textContent = strings.goButton; 

        document.getElementById('btn-categorias').textContent = strings.categories;
        document.getElementById('btn-lenguaje').textContent = strings.language;
        document.getElementById('btn-comollegar').textContent = strings.getThere;
        document.getElementById('btn-info').textContent = strings.info;

        // Actualizar textos de los chips de categor√≠a
        const categoryChipTexts = [strings.chipHealth, strings.chipShopping, strings.chipEntertainment, strings.chipDental];
        categoryChips.forEach((chip, index) => {
            chip.textContent = categoryChipTexts[index];
        });

        alertUser(`Interfaz y conversaci√≥n cambiadas a ${lang === 'es' ? 'Espa√±ol' : 'English'}`, 'i');
    }

    // L√ìGICA DE OCULTAMIENTO REVISADA: Solo los botones del men√∫ principal (action chips) controlan la visibilidad.
    function handleMenuAction(actionChip) {
        const action = actionChip.getAttribute('data-action');
        const lang = currentLanguage;
        const query = actionChip.getAttribute(`data-query-${lang}`);

        vibrateDevice(); 

        // L√≥gica para ocultar otros men√∫s y resetear estados
        if (action !== 'CATEGORIES' && categoriesVisible) {
            hideChipGroup(categoryChipsGroup, categoryChips);
            categoriesVisible = false;
        }
        if (action !== 'LANGUAGE' && languageMenuVisible) {
            hideChipGroup(languageChipsGroup, languageChips);
            languageMenuVisible = false;
        }


        if (action === 'CATEGORIES') {
            if (categoriesVisible) {
                hideChipGroup(categoryChipsGroup, categoryChips);
                categoriesVisible = false;
            } else {
                showChipGroupWithWave(categoryChipsGroup, categoryChips);
                categoriesVisible = true;
            }
        } else if (action === 'LANGUAGE') {
            if (languageMenuVisible) {
                hideChipGroup(languageChipsGroup, languageChips);
                languageMenuVisible = false;
            } else {
                showChipGroupWithWave(languageChipsGroup, languageChips);
                languageMenuVisible = true;
            }
        } else {
            // Acciones directas (C√≥mo Llegar, Info)
            if (query) {
                // Si la acci√≥n es C√≥mo Llegar o Info, env√≠a la consulta Y oculta los men√∫s activos.
                handleSend(query); 
                if (categoriesVisible) { hideChipGroup(categoryChipsGroup, categoryChips); categoriesVisible = false; }
                if (languageMenuVisible) { hideChipGroup(languageChipsGroup, languageChips); languageMenuVisible = false; }
            }
        }
    }
    
    // Funci√≥n para crear las burbujas de mensaje (User/Model)
    function createMessageBubble(m) {
        const w = document.createElement('div');
        
        if (m.role === 'user') { 
            w.className = 'flex justify-end mb-2'; 
            w.innerHTML = `<div class="user-bubble bg-blue-500 text-white p-3 shadow-md">${m.text}</div>`; 
        } 
        else if (m.role === 'model') {
            w.className = 'flex flex-col justify-start w-full mb-2';
            let content = '';

            if (m.isStructured) { 
                const placeName = m.placeName || 'Ubicaci√≥n'; 
                const nameAndCity = encodeURIComponent(placeName + " Nuevo Progreso Tamps");
                const directionsUrl = `https://www.google.com/maps/search/?api=1&query=${nameAndCity}`; 
                const searchUrl = `https://www.google.com/search?q=${nameAndCity}`;
                const phoneUrl = m.placePhone ? `tel:${m.placePhone}` : `javascript:alert('N√∫mero de tel√©fono no disponible. Intenta buscar en Google.')`;
                const isGenericPhone = !m.placePhone || m.placePhone === '+52 899 900 0000';
                
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">¬°Claro! Aqu√≠ est√° la informaci√≥n sobre **${placeName}** que tengo como tu gu√≠a local:<br><br>${m.text}</div>`;
                
                const actionsBar = `
                    <div class="action-bar-container">
                        <div class="inline-flex space-x-3 p-1">
                            <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition flex-shrink-0 text-sm">${currentLanguage === 'es' ? 'Ver en Mapa üó∫Ô∏è' : 'View on Map üó∫Ô∏è'}</a>
                            <a href="${phoneUrl}" class="action-btn ${isGenericPhone ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600' } text-white font-semibold py-2 px-4 rounded-lg transition flex-shrink-0 text-sm">${currentLanguage === 'es' ? 'Llamar üìû' : 'Call üìû'}</a>
                            <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-yellow-500 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition flex-shrink-0 text-sm">${currentLanguage === 'es' ? 'Buscar en Google üîç' : 'Search on Google üîç'}</a>
                        </div>
                    </div>
                `;
                
                w.innerHTML = content + actionsBar;

            } else {
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">${m.text || ''}</div>`;
                w.innerHTML = content;
            }
        }
        return w;
    }

    function renderChat() {
        if (messageContainer) {
            messageContainer.innerHTML = '';
            chatHistory.forEach((m) => { messageContainer.appendChild(createMessageBubble(m)); });
            scrollToBottom();
        }
    }

    // --- L√ìGICA DE CONEXI√ìN CON GEMINI (AJUSTE DE IDIOMA Y MODO CONVERSACIONAL) ---

    async function getGeminiResponse(userPrompt, chatHistoryForAPI) {
        
        const LATITUDE = 26.064;
        const LONGITUDE = -98.005;
        const targetLang = currentLanguage === 'es' ? 'en espa√±ol' : 'in English';
        
        // El prompt ahora define cu√°ndo usar el JSON y cu√°ndo no.
        const systemPrompt = `Eres PROGRESO TOUR GUIDE, un gu√≠a experto en Nuevo Progreso, Tamaulipas, M√©xico (${LATITUDE}, ${LONGITUDE}).
        
        **REGLAS DE RESPUESTA:**
        1. **RESPONDE SIEMPRE ${targetLang}.**
        2. **MODO DE RESPUESTA:**
           - **MODO FICHA (JSON):** √ösalo **SOLO** si la solicitud del usuario es claramente una b√∫squeda de un **lugar, negocio, servicio, o categor√≠a espec√≠fica** (ej: "mejor restaurante", "Top 10 Dentistas", "Salud y Est√©tica").
           - **MODO CONVERSACIONAL (Texto Plano):** √ösalo si la solicitud es general, de saludo, de seguimiento de chat, o preguntas abiertas (ej: "¬øC√≥mo est√°s?", "¬øQu√© tal el clima?", "Gracias").
        3. **FORMATO JSON REQUERIDO (Solo en MODO FICHA):**
           \`\`\`json
           {
             "placeName": "Nombre del Lugar (en el idioma solicitado)",
             "description": "Saludo y descripci√≥n corta y atractiva (en el idioma solicitado).",
             "placePhone": "+52 899 900 0000",
             "isStructured": true
           }
           \`\`\`
        4. Si usas el MODO FICHA, la √∫nica respuesta debe ser el bloque JSON. Si usas el MODO CONVERSACIONAL, la respuesta debe ser texto plano.

        Responde a la siguiente solicitud del usuario.
        `;

        let contents = [];
        chatHistoryForAPI.forEach(m => {
            let textToSend = m.isStructured ? `[PROGRESO TOUR GUIDE SENT CARD about ${m.placeName}]` : m.text;
            if (m.role && textToSend && textToSend.length > 5) { contents.push({ role: m.role, parts: [{ text: textToSend }] }); }
        });

        contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\nSolicitud del usuario: " + userPrompt }] });

        try {
            const response = await fetch(BACKEND_URL, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: contents }) 
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error HTTP: ${response.status}. Mensaje: ${errorData.error.message || 'El proxy de Vercel fall√≥.'}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();

        } catch (error) {
            console.error("Fallo del Proxy o API de Gemini:", error);
            if (typeof alertUser === 'function') {
                alertUser(`Error de conexi√≥n: ${error.message}.`, 'error');
            }
            return null;
        }
    }

    // --- L√≥gica Principal del Chatbot (handleSend) ---
    async function handleSend(userPromptInput = null) {
        const userPrompt = userPromptInput || inputElement.value.trim();
        if (!userPrompt) return;
        
        // Oculta los chips si el usuario escribe o usa un bot√≥n de acci√≥n r√°pida (C√≥mo Llegar/Info).
        hideChipGroup(categoryChipsGroup, categoryChips);
        categoriesVisible = false;
        hideChipGroup(languageChipsGroup, languageChips);
        languageMenuVisible = false;

        if (typeof toggleInput === 'function') toggleInput(true);
        chatHistory.push({ role: 'user', text: userPrompt });
        if (typeof renderChat === 'function') renderChat();
        inputElement.value = '';

        const historyForGemini = [...chatHistory];
        historyForGemini.pop(); 
        
        const MAX_MESSAGES = 6;
        let limitedHistory = historyForGemini.length > MAX_MESSAGES ? historyForGemini.slice(historyForGemini.length - MAX_MESSAGES) : historyForGemini;
        
        let modelResponseText = await getGeminiResponse(userPrompt, limitedHistory);
        let finalMessage = { role: 'model', text: modelResponseText };

        // Intenta parsear la respuesta como JSON estructurado
        try {
            const jsonStart = modelResponseText.indexOf('{');
            const jsonEnd = modelResponseText.lastIndexOf('}');
            
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonString = modelResponseText.substring(jsonStart, jsonEnd + 1);
                const parsedJson = JSON.parse(jsonString);

                if (parsedJson.isStructured === true) {
                    finalMessage = {
                        role: 'model',
                        isStructured: true, 
                        text: parsedJson.description || modelResponseText,
                        placeName: parsedJson.placeName || "Lugar Desconocido", 
                        placePhone: parsedJson.placePhone || null, 
                        placeId: true 
                    };
                    if (typeof alertUser === 'function') alertUser(UI_STRINGS[currentLanguage].alertStructured(finalMessage.placeName), "i");
                }
            }
        } catch (e) {
            finalMessage.text = modelResponseText;
        }

        chatHistory.push(finalMessage);
        
        if (typeof renderChat === 'function') renderChat();
        if (typeof toggleInput === 'function') toggleInput(false);
    }
    
    // --- Event Listeners e Inicio ---
    if (sendButton) sendButton.addEventListener('click', () => handleSend());
    if (inputElement) inputElement.addEventListener('keypress', function(e) { if (e.key === 'Enter') { handleSend(); } });
    
    // Listeners para botones del men√∫ principal (Categor√≠as, Lenguaje, etc.)
    menuActionChips.forEach(chip => {
        chip.addEventListener('click', function() {
            handleMenuAction(this);
        });
    });

    // Oculta chips de categor√≠a despu√©s de usarlos.
    categoryChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const lang = currentLanguage;
            const query = this.getAttribute(`data-query-${lang}`);
            handleSend(query); 
            // Ocultamiento
            hideChipGroup(categoryChipsGroup, categoryChips);
            categoriesVisible = false;
        });
    });

    // Oculta chips de idioma despu√©s de usarlos (la funci√≥n setInterfaceLanguage ya lo hace).
    languageChips.forEach(chip => {
        chip.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            setInterfaceLanguage(lang);
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        setInterfaceLanguage('es'); 
    });
</script>
</body>
</html>
