<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso Tour Guide</title>
<link href="https://fonts.cdnfonts.com/css/avenir" rel="stylesheet">
                
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Estilos base: Asegurar Full Height y Full Width */
        html, body { font-family:Avenir; height: 100%; margin: 0; padding: 0; }
        .chat-window { height: 100%; width: 100vw; display: flex; flex-direction: column; background-color: #f7f7f7; overflow: hidden }
        .user-bubble { border-radius: 18px 18px 0 18px; max-width: 80% }
        .model-bubble { border-radius: 18px 18px 18px 0; max-width: 80%;padding-left:8px; }
        .action-bar-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-top: 10px; padding-bottom: 5px }
        .action-btn { white-space: nowrap }
        
        /* Ajuste de Chips: Asegura el scroll horizontal */
        .chip-group-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; white-space: nowrap; }
        
        /* Estilo personalizado de la barra de chat */
        .map-search-bar {
            background-color: white; 
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            padding: 4px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .map-input {
            flex-grow: 1;
            padding: 0.75rem 0.75rem; 
            color: #9ca3af;
            font-size: 1.125rem;
            background: transparent;
            border: none;
            min-width: 0; 
        }
        .go-button {
            background-color: black;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 15px;
            padding: 0.5rem 1rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            transition: hover:opacity-90 disabled:opacity-50;
            flex-shrink: 0;
            min-width: 60px;
            height: 44px;
            box-sizing: border-box;
            margin-right: 4px;
        }
        .go-button svg {
            margin-right: 0.25rem;
            width: 1.25rem; 
            height: 1.25rem;
            fill: currentColor;
        }

        /* --- Animaci√≥n de Vibraci√≥n (Aplicada al bot√≥n) --- */
        @keyframes vibrate {
            0% { transform: translate(0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, -2px); }
            100% { transform: translate(2px, 2px); }
        }
        .vibrating {
            animation: vibrate 0.1s ease-in-out infinite;
        }
        /* --- Efecto Ola y Transici√≥n para los Chips --- */
        .category-chip.hidden-chip {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .category-chip.visible-chip {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.8.5/dist/dotlottie-wc.js" type="module"></script>
</head>
<body>
    <div id="chat-window" class="chat-window h-screen w-full"> 
        <div class="flex items-center justify-between p-4 bg-white text-gray-800 font-bold border-b border-gray-200 flex-shrink-0 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
            <span class="text-lg">PROGRESO TOUR GUIDE</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        </div>

        <div id="message-container" class="flex-grow overflow-y-auto p-4 flex flex-col"></div>

        <div id="loading-indicator" class="flex justify-start hidden p-4 pl-1 flex-shrink-0" style="margin-left:-42px;margin-bottom:-22px;">
            <dotlottie-wc src="https://lottie.host/65b2d1fc-9840-476c-867e-6236ce234b38/SwsGK4ZVOj.lottie" style="width: 150px; height:" autoplay loop></dotlottie-wc>
        </div>
        
        <div id="app-alert-container" class="fixed top-2 w-full flex justify-center z-50"></div>

        <div id="quick-replies-container" class="quick-replies-container p-3 border-t border-gray-100 bg-white flex-shrink-0 flex flex-col space-y-2">
            
            <div id="category-chips-group" class="chip-group-scroll hidden">
                <div class="inline-flex space-x-3 pb-3 border-b border-gray-200"> 
                    <div class="quick-reply-chip category-chip hidden-chip flex items-center p-2 rounded-xl text-sm border border-green-500 bg-green-50 text-green-700 cursor-pointer transition hover:bg-green-100" data-query="Categor√≠a Salud y Est√©tica en Progreso">üè• Salud & Est√©tica</div>
                    <div class="quick-reply-chip category-chip hidden-chip flex items-center p-2 rounded-xl text-sm border border-blue-500 bg-blue-50 text-blue-700 cursor-pointer transition hover:bg-blue-100" data-query="Categor√≠a Compras y Tiendas en Progreso">üõçÔ∏è Compras</div>
                    <div class="quick-reply-chip category-chip hidden-chip flex items-center p-2 rounded-xl text-sm border border-purple-500 bg-purple-50 text-purple-700 cursor-pointer transition hover:bg-purple-100" data-query="Categor√≠a Entretenimiento y Atracciones en Progreso">üé∫ Entretenimiento</div>
                    <div class="quick-reply-chip category-chip hidden-chip flex items-center p-2 rounded-xl text-sm border border-yellow-500 bg-yellow-50 text-yellow-700 cursor-pointer transition hover:bg-yellow-100" data-query="Top 10 Dentistas en Progreso">ü¶∑ Top 10 Dental</div>
                </div>
            </div>
            
            <div id="menu-actions" class="chip-group-scroll">
                <div class="inline-flex space-x-3 pt-2">
                    <div id="btn-categorias" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="CATEGORIES">üìÇ Categor√≠as</div>
                    <div id="btn-lenguaje" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="LANGUAGE" data-query="Activa modo traducci√≥n en espa√±ol-ingl√©s.">üåê Lenguaje</div>
                    <div id="btn-comollegar" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="GET_THERE" data-query="Dime c√≥mo llegar a Progreso, Tamaulipas.">üìç C√≥mo Llegar</div>
                    <div id="btn-info" class="menu-action-chip action-chip flex items-center p-2 rounded-full text-sm font-semibold bg-gray-200 text-gray-800 cursor-pointer transition hover:bg-gray-300" data-action="INFO" data-query="Informaci√≥n general sobre Nuevo Progreso.">‚ÑπÔ∏è Info</div>
                </div>
            </div>
        </div>
        
        <div class="p-4 bg-white shadow-xl flex-shrink-0">
            <div class="map-search-bar w-full">
                <input type="text" id="user-input" class="map-input focus:outline-none focus:ring-0" placeholder="Ask the map">
                
                <button id="go-button" class="go-button transition hover:opacity-90 disabled:opacity-50">
                    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 122.88 122.88" class="h-5 w-5"><g><path class="st0" d="M62.43,122.88h-1.98c0-16.15-6.04-30.27-18.11-42.34C30.27,68.47,16.16,62.43,0,62.43v-1.98 c16.16,0,30.27-6.04,42.34-18.14C54.41,30.21,60.45,16.1,60.45,0h1.98c0,16.15,6.04,30.27,18.11,42.34 c12.07,12.07,26.18,18.11,42.34,18.11v1.98c-16.15,0-30.27,6.04-42.34,18.11C68.47,92.61,62.43,106.72,62.43,122.88L62.43,122.88z"/></g></svg>
                    Go
                </button>
            </div>
        </div>
        </div>

<script>
    // --- BLOQUE JAVASCRIPT: SETUP Y UTILIDADES ---
    
    // ‚úÖ RUTA RELATIVA: Usamos /api. Como el frontend y el backend est√°n en el mismo dominio (Vercel), el CORS se elimina.
    const BACKEND_URL = "/api"; 
    
    let chatHistory = [];
    let categoriesVisible = false; // Nuevo estado para controlar la visibilidad de las categor√≠as
    
    // Referencias a Elementos del DOM
    const inputElement = document.getElementById('user-input');
    const sendButton = document.getElementById('go-button'); 
    const messageContainer = document.getElementById('message-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const appAlertContainer = document.getElementById('app-alert-container');
    const categoryChipsGroup = document.getElementById('category-chips-group');
    const categoryChips = document.querySelectorAll('#category-chips-group .category-chip');
    const menuActionChips = document.querySelectorAll('#menu-actions .menu-action-chip');

    // Inicializaci√≥n del estado
    if (inputElement) inputElement.disabled = false;
    if (sendButton) sendButton.disabled = false;

    // Funci√≥n para mostrar alertas temporales
    function alertUser(m, t='i') {
        if (appAlertContainer && appAlertContainer.querySelector('.app-alert')) appAlertContainer.querySelector('.app-alert').remove();
        const a = document.createElement('div');
        const bg = (t === 'error') ? 'bg-red-500' : 'bg-blue-500';
        a.className = `app-alert p-3 rounded-lg text-white font-semibold shadow-lg transition-opacity duration-300 z-50 ${bg} mb-2`;
        a.textContent = m;
        if (appAlertContainer) appAlertContainer.appendChild(a);
        setTimeout(() => { a.style.opacity = '0'; setTimeout(() => a.remove(), 300); }, 4000);
    }
    
    // Funci√≥n para hacer scroll
    function scrollToBottom() { 
        if (messageContainer) messageContainer.scrollTop = messageContainer.scrollHeight; 
    }
    
    // Funci√≥n para gestionar el estado de entrada
    function toggleInput(d) {
        if (inputElement) inputElement.disabled = d;
        if (sendButton) sendButton.disabled = d;
        if (loadingIndicator) loadingIndicator.classList.toggle('hidden', !d);
        if (inputElement) inputElement.placeholder = d ? "" : "Ask the map";
    }

    // --- NUEVAS FUNCIONES DE INTERACCI√ìN ---

    // Funci√≥n para la animaci√≥n de vibraci√≥n
    function vibrateButton(element) {
        element.classList.add('vibrating');
        setTimeout(() => {
            element.classList.remove('vibrating');
        }, 300); // 300ms es la duraci√≥n de la vibraci√≥n
    }

    // Oculta los chips de categor√≠as (sin animaci√≥n)
    function hideCategoryChips() {
        categoryChipsGroup.classList.add('hidden');
        categoryChips.forEach(chip => {
            chip.classList.remove('visible-chip');
            chip.classList.add('hidden-chip');
        });
        categoriesVisible = false;
    }

    // Muestra los chips con efecto "ola"
    function showCategoryChipsWithWave() {
        if (categoriesVisible) return; // Evita mostrar si ya son visibles
        categoryChipsGroup.classList.remove('hidden');
        categoriesVisible = true;

        categoryChips.forEach((chip, index) => {
            // Elimina la transici√≥n inicial
            chip.style.transition = 'none';
            chip.classList.remove('visible-chip');
            chip.classList.add('hidden-chip');

            // Fuerza un reflow para resetear la animaci√≥n
            void chip.offsetWidth; 

            // Aplica la transici√≥n y muestra con un retraso (efecto ola)
            setTimeout(() => {
                chip.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                chip.classList.remove('hidden-chip');
                chip.classList.add('visible-chip');
            }, index * 100); // 100ms de retraso entre cada chip
        });
    }

    // Maneja la acci√≥n de los botones del men√∫ principal
    function handleMenuAction(actionChip) {
        const action = actionChip.getAttribute('data-action');
        const query = actionChip.getAttribute('data-query');

        // 1. Efecto de Vibraci√≥n
        vibrateButton(actionChip);

        // 2. L√≥gica de Ocultar/Mostrar
        if (action === 'CATEGORIES') {
            if (categoriesVisible) {
                hideCategoryChips(); // Si Categor√≠as ya est√° activo, lo oculta.
            } else {
                showCategoryChipsWithWave(); // Si no est√° activo, lo muestra.
            }
        } else {
            // Si se presiona cualquier otro bot√≥n (Lenguaje, C√≥mo Llegar, Info)
            hideCategoryChips();
            if (query) {
                handleSend(query);
            }
        }
    }
    
    // Funci√≥n para crear las burbujas de mensaje (User/Model)
    function createMessageBubble(m) {
        const w = document.createElement('div');
        
        if (m.role === 'user') { 
            w.className = 'flex justify-end mb-2'; 
            w.innerHTML = `<div class="user-bubble bg-blue-500 text-white p-3 shadow-md">${m.text}</div>`; 
        } 
        else if (m.role === 'model') {
            w.className = 'flex flex-col justify-start w-full mb-2';
            let content = '';

            // L√≥gica para mensajes estructurados con botones de acci√≥n
            if (m.isStructured) { 
                // Asegurar que placeName exista para los botones
                const placeName = m.placeName || 'Ubicaci√≥n'; 
                const nameAndCity = encodeURIComponent(placeName + " Nuevo Progreso Tamps");
                // NOTA: Usamos un placeholder para Google Maps ya que la Places API no est√° activa
                const directionsUrl = `https://www.google.com/maps/search/?api=1&query=${nameAndCity}`; 
                const searchUrl = `https://www.google.com/search?q=${nameAndCity}`;
                
                // Usar m.placePhone, con un fallback seguro si no est√°.
                const phoneUrl = m.placePhone ? `tel:${m.placePhone}` : `javascript:alert('N√∫mero de tel√©fono no disponible. Intenta buscar en Google.')`;
                const isGenericPhone = !m.placePhone || m.placePhone === '+52 899 900 0000';
                
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">¬°Claro! Aqu√≠ est√° la informaci√≥n sobre **${placeName}** que tengo como tu gu√≠a local:<br><br>${m.text}</div>`;
                
                const actionsBar = `
                    <div class="action-bar-container">
                        <div class="inline-flex space-x-3 p-1">
                            <a href="${directionsUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition flex-shrink-0 text-sm">Ver en Mapa üó∫Ô∏è</a>
                            <a href="${phoneUrl}" class="action-btn ${isGenericPhone ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600' } text-white font-semibold py-2 px-4 rounded-lg transition flex-shrink-0 text-sm">Llamar üìû</a>
                            <a href="${searchUrl}" target="_blank" rel="noopener noreferrer" class="action-btn bg-yellow-500 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition flex-shrink-0 text-sm">Buscar en Google üîç</a>
                        </div>
                    </div>
                `;
                
                w.innerHTML = content + actionsBar;

            } else {
                // L√≥gica para mensajes de texto simple
                content = `<div class="model-bubble bg-gray-200 text-gray-800 p-3 shadow-md">${m.text || ''}</div>`;
                w.innerHTML = content;
            }
        }
        return w;
    }

    // Funci√≥n para renderizar el historial de chat
    function renderChat() {
        if (messageContainer) {
            messageContainer.innerHTML = '';
            chatHistory.forEach((m) => { messageContainer.appendChild(createMessageBubble(m)); });
            scrollToBottom();
        }
    }

    // --- BLOQUE JAVASCRIPT: L√ìGICA CENTRAL Y EVENTOS ---

    // Funci√≥n que llama al proxy de Vercel (donde reside la clave)
    async function getGeminiResponse(userPrompt, chatHistoryForAPI) {
        
        const LATITUDE = 26.064;
        const LONGITUDE = -98.005;

        // SYSTEM PROMPT RESTABLECIDO: Prioriza SIEMPRE la ficha JSON, incluso inventando datos si es necesario.
        const systemPrompt = `Eres PROGRESO TOUR GUIDE, un gu√≠a experto en Nuevo Progreso, Tamaulipas, M√©xico (${LATITUDE}, ${LONGITUDE}). Tu objetivo principal es ofrecer una ficha estructurada con informaci√≥n √∫til para el turista.
        
        **REGLAS DE RESPUESTA:**
        1.  **SIEMPRE responde con el objeto JSON requerido**, independientemente de si tienes informaci√≥n verificada del lugar. Si no conoces el lugar exacto, inventa una descripci√≥n plausible y un n√∫mero de tel√©fono gen√©rico (+52 899 900 0000) para asegurar que la ficha de informaci√≥n se muestre al usuario.
        2.  Si el usuario pide una lista o recomendaci√≥n general (ej: "5 restaurantes"), genera una descripci√≥n general en la ficha JSON y usa un nombre gen√©rico (ej: "Restaurantes Populares").
            
        **FORMATO JSON REQUERIDO:**
        \`\`\`json
        {
          "placeName": "Nombre del Lugar (Puede ser inventado o gen√©rico si no se encuentra)",
          "description": "Saludo y descripci√≥n corta y atractiva sobre el lugar.",
          "placePhone": "+52 899 900 0000",
          "isStructured": true
        }
        \`\`\`
        
        Responde a la siguiente solicitud del usuario.
        `;
        // FIN SYSTEM PROMPT RESTABLECIDO

        let contents = [];
        chatHistoryForAPI.forEach(m => {
            let textToSend = m.isStructured ? `[PROGRESO TOUR GUIDE ENVI√ì FICHA sobre ${m.placeName}]` : m.text;
            if (m.role && textToSend && textToSend.length > 5) { contents.push({ role: m.role, parts: [{ text: textToSend }] }); }
        });

        contents.push({ role: "user", parts: [{ text: systemPrompt + "\n\nSolicitud del usuario: " + userPrompt }] });

        try {
            const response = await fetch(BACKEND_URL, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: contents }) 
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error HTTP: ${response.status}. Mensaje: ${errorData.error.message || 'El proxy de Vercel fall√≥.'}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text.trim();

        } catch (error) {
            console.error("Fallo del Proxy o API de Gemini:", error);
            if (typeof alertUser === 'function') {
                alertUser(`Error de conexi√≥n con el servidor (Proxy Vercel): ${error.message}.`, 'error');
            }
            return null;
        }
    }

    // --- L√≥gica Principal del Chatbot (handleSend) ---
    async function handleSend(userPromptInput = null) {
        const userPrompt = userPromptInput || inputElement.value.trim();
        if (!userPrompt) return;
        
        // Al enviar un mensaje, ocultamos las categor√≠as si est√°n visibles
        hideCategoryChips();
        
        if (typeof toggleInput === 'function') toggleInput(true);
        chatHistory.push({ role: 'user', text: userPrompt });
        if (typeof renderChat === 'function') renderChat();
        inputElement.value = '';

        const historyForGemini = [...chatHistory];
        historyForGemini.pop(); 
        
        const MAX_MESSAGES = 6;
        let limitedHistory = historyForGemini.length > MAX_MESSAGES ? historyForGemini.slice(historyForGemini.length - MAX_MESSAGES) : historyForGemini;
        
        let modelResponseText = await getGeminiResponse(userPrompt, limitedHistory);
        let finalMessage = { role: 'model', text: modelResponseText };

        // Intenta parsear la respuesta como JSON estructurado
        try {
            const jsonStart = modelResponseText.indexOf('{');
            const jsonEnd = modelResponseText.lastIndexOf('}');
            
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonString = modelResponseText.substring(jsonStart, jsonEnd + 1);
                const parsedJson = JSON.parse(jsonString);

                if (parsedJson.isStructured === true) {
                    finalMessage = {
                        role: 'model',
                        isStructured: true, // <-- Aseguramos que sea 'true'
                        text: parsedJson.description || modelResponseText,
                        // A√±adimos fallbacks para asegurar que los botones funcionen si las propiedades faltan
                        placeName: parsedJson.placeName || "Lugar Desconocido", 
                        placePhone: parsedJson.placePhone || null, 
                        placeId: true 
                    };
                    if (typeof alertUser === 'function') alertUser(`¬°Ficha generada por IA para ${finalMessage.placeName}!`, "i");
                }
            }
        } catch (e) {
             // Si el JSON falla o es incompleto, trata toda la respuesta como texto plano
            finalMessage.text = modelResponseText;
        }

        chatHistory.push(finalMessage);
        
        if (typeof renderChat === 'function') renderChat();
        if (typeof toggleInput === 'function') toggleInput(false);
    }
    
    // --- Event Listeners e Inicio ---
    if (sendButton) sendButton.addEventListener('click', () => handleSend());
    if (inputElement) inputElement.addEventListener('keypress', function(e) { if (e.key === 'Enter') { handleSend(); } });
    
    // 1. Listeners para los botones del men√∫ principal (Categor√≠as, Lenguaje, etc.)
    menuActionChips.forEach(chip => {
        chip.addEventListener('click', function() {
            handleMenuAction(this);
        });
    });

    // 2. Listeners para los chips de categor√≠as (los que env√≠an queries)
    categoryChips.forEach(chip => {
        chip.addEventListener('click', function() {
            // Oculta las categor√≠as inmediatamente al presionar un chip de categor√≠a
            hideCategoryChips(); 
            const query = this.getAttribute('data-query');
            handleSend(query); 
        });
    });
</script>
</body>
</html>
